# Function to show progress
function Show-Progress {
    param (
        [int]$PercentComplete,
        [string]$Status
    )
    Write-Progress -Activity "Installation Progress" -PercentComplete $PercentComplete -Status $Status
}

# Function to log and display messages
function Log-Message {
    param (
        [string]$Message
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] $Message"
}

# Enable WSL and set WSL 2 as default
Log-Message "Enabling WSL and setting WSL 2 as default..."
Show-Progress -PercentComplete 10 -Status "Enabling WSL and setting WSL 2 as default..."
wsl --install
wsl --set-default-version 2

# Install Ubuntu
Log-Message "Downloading and installing Ubuntu..."
Show-Progress -PercentComplete 30 -Status "Downloading and installing Ubuntu..."
Invoke-WebRequest -Uri https://aka.ms/wslubuntu2004 -OutFile Ubuntu.appx -UseBasicParsing
Add-AppxPackage .\Ubuntu.appx

# Wait for Ubuntu to be initialized
Log-Message "Waiting for Ubuntu initialization..."
Show-Progress -PercentComplete 40 -Status "Waiting for Ubuntu initialization..."
Start-Sleep -Seconds 30

# Create the install_remnux.sh script content
Log-Message "Creating the REMnux installation script..."
Show-Progress -PercentComplete 50 -Status "Creating the REMnux installation script..."
$installRemnuxScript = @"
#!/bin/bash

# Update the package list and install prerequisites
echo 'Updating package list and installing prerequisites...'
sudo apt update
sudo apt -y upgrade

# Install REMnux
echo 'Installing REMnux...'
curl -s https://remnux.org/get-remnux.sh | sudo bash

# Verify REMnux installation
echo 'Verifying REMnux installation...'
remnux check
"@

# Write the install_remnux.sh script to the Ubuntu filesystem
Log-Message "Writing the REMnux installation script to Ubuntu..."
Show-Progress -PercentComplete 60 -Status "Writing the REMnux installation script to Ubuntu..."
wsl -d Ubuntu-20.04 -- bash -c "echo '$installRemnuxScript' > /tmp/install_remnux.sh"
wsl -d Ubuntu-20.04 -- bash -c "chmod +x /tmp/install_remnux.sh"

# Run the REMnux installation script
Log-Message "Running the REMnux installation script..."
Show-Progress -PercentComplete 80 -Status "Running the REMnux installation script..."
wsl -d Ubuntu-20.04 -- bash /tmp/install_remnux.sh

Show-Progress -PercentComplete 100 -Status "Installation complete."
Log-Message "Installation complete."
Write-Host "Installation complete."
